#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.expand_path('../../lib', __FILE__))
require 'biotcm'
require 'json'

# Get the list of all apps
apps_file = BioTCM.path_to('data/apps.json')
apps = JSON.parse(
  begin
    # Try to use the latest
    json = BioTCM.get(BioTCM::DEFAULT_APPS_FILE)
    File.open(apps_file, 'w').write json
    json
  rescue
    # Or use the one downloaded previously
    raise 'Please connect to Internet to get the latest list of apps' unless File.exist?(apps_file)
    File.read(apps_file)
  end
)
apps.reject! { |k, _| /^__/ =~ k }

# Get lists of apps
available_gems = `gem list biotcm- --no-versions`.split("\n")
gem_apps = apps.keys.select { |k| available_gems.include? apps[k][0] }
built_in_apps = apps.keys.select { |k| apps[k][0] == '(built-in)' }

if (cmd = ARGV.shift).nil? || cmd == '-h'
  # Help message
  puts <<-END_OF_DOC
Usage: biotcm app [OPTIONS]

Available apps:
  END_OF_DOC
  (built_in_apps + gem_apps).sort.each { |app| puts '  ' + app }
elsif built_in_apps.include?(cmd)
  BioTCM::Apps.const_get(apps[cmd][1]).new.run
elsif gem_apps.include?(cmd)
  require apps[cmd][0]
  BioTCM::Apps.const_get(apps[cmd][1]).new.run
else
  # Error message
  puts "Sorry. BioTCM can't find app \"#{cmd}\"."
end
